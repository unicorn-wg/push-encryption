<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" 
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">

<html lang="en" xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head profile="http://www.w3.org/2006/03/hcard http://dublincore.org/documents/2008/08/04/dc-html/">
  <meta http-equiv="Content-Type" content="text/html; charset=us-ascii" />

  <title>Message Encryption for Web Push</title>

  
<style type="text/css">/*<![CDATA[*/
@viewport {
  zoom: 1.0;
  width: extend-to-zoom;
}
@-ms-viewport {
  width: extend-to-zoom;
  zoom: 1.0;
}

@media screen and (min-width: 1024px) {
  ul.toc, #rfc\.toc {
    position: fixed;
    bottom: 0;
    right: 0;
    right: calc(50vw - 525px);
    width: 300px;
    z-index: 1;
  }
  #rfc\.toc {
    top: 15px;
  }
  ul.toc {
    top: 80px;
    overflow: auto;
  }

  body {
    padding-right: 350px;
  }
}

body {
  font: 15px "Helvetica Neue",Helvetica,Arial,sans-serif;
  color: #333;
  font-size-adjust: 0.5;
  line-height: 130%;
  margin: 25px auto;
  max-width: 724px;
}

.title, .filename, h1, h2, h3, h4 {
  font-family: "Helvetica Neue",Helvetica,Arial,sans-serif;
  font-size-adjust: 0.5;
  font-weight: 500;
  color: #333;
  line-height: 100%;
  margin: 0.8em 0 0.3em;
}
.title { font-size: 36px; }
h1 { font-size: 30px; }
h2 { font-size: 24px; }
h3, h4 { font-size: 18px; }
h1 a[href], h2 a[href], h3 a[href], h4 a[href] {
  color: #333;
}

ul.toc li {
  list-style: none;
  text-indent: -2.5em;
  padding-left: 2.5em;
  padding-bottom: 5px;
  margin: 0;
}
ul.toc ul {
  margin: 0;
}
/* xml2rfc nests ul directly inside ul which messes with the style badly */
ul.toc, ul.toc>ul, ul.toc ul>ul {
  margin: 0 0 0 1.5em;
}

table {
  margin-left: 0em;
  border-collapse: collapse;
}
th {
  text-align: left;
  border-bottom: 2px solid #ddd;
}
td {
  border-top: 1px solid #ddd;
  vertical-align: top;
}
tr:nth-child(2n+1) > td,
tr:nth-child(2n+1) > th {
  background-color: #f9f9f9;
}
td.reference {
  max-width: 200px;
  border-top: none;
  padding-right: 1em;
}
.right {
  text-align: right;
}


table.header {
  width: 100%;
}
table.header td {
  border: none;
  background-color: transparent;
  color: black;
}
.filename {
  color: rgb(119, 119, 119);
  font-size: 23px;
  font-weight: normal;
  height: auto;
  line-height: 100%;
}
#rfc\.abstract+p {
  font-size: 20px;
  font-weight: 300;
  line-height: 130%;
}

samp, tt, code, pre {
  font: 11pt consolas, monospace;
  font-size-adjust: none;
}
pre {
  background-color: #eee;
  border: 1px solid #ddd;
  overflow-x: auto;
  padding: 5px;
  margin: 5px;
}
.figure {
  font-style: italic;
  margin: 0 1.5em;
}

address {
  margin: 10px 0 0;
}
.vcard {
  font-style: normal;
}
.vcardline {
  display: block;
}
.vcardline .fn {
  font-weight: bold;
}
.vcardline .hidden {
  display: none;
}

dl {
  margin-left: 1em;
}
dl.dl-horizontal: {
  margin-left: 0;
}
dl > dt {
  float: left;
  margin-right: 1em;
}
dl.nohang > dt {
  float: none;
}
dl > dd {
  margin-bottom: .5em;
}
dl.compact > dd {
  margin-bottom: 0em;
}
dl > dd > dl {
  margin-top: 0.5em;
  margin-bottom: 0em;
}
ul.empty {
  list-style-type: none;
}
ul.empty li {
  margin-top: .5em;
}

hr {
  border: 0;
  border-top: 1px solid #eee;
}

a {
  text-decoration: none;
}
a[href] {
  color: #2a6496;
}
a[href]:hover {
  background-color: #eee;
}

ol, ul, li, p {
  padding: 0;
  margin: 0.5em 0 0.5em 2em;
}
li, p {
  margin-left: 0;
}
address {
  font-style: normal;
}

.github-fork-ribbon-wrapper {
  display: none;
}
@media screen and (min-width: 800px) {
  /* "Fork me on GitHub" CSS ribbon based on
   * https://github.com/simonwhitaker/github-fork-ribbon-css
   */
  .github-fork-ribbon {
    position: absolute;
    padding: 2px 0;
    background-color: #a00;
    background-image: linear-gradient(to bottom, rgba(0, 0, 0, 0), rgba(0, 0, 0, 0.15));
    box-shadow: 0 2px 3px 0 rgba(0, 0, 0, 0.5);
    font: 700 12px "Helvetica Neue", Helvetica, Arial, sans-serif;

    pointer-events: auto;

    top: 38px;
    right: -45px;

    transform: rotate(45deg);
  }

  .github-fork-ribbon a[href],
  .github-fork-ribbon a[href]:hover {
    color: #fff;
    background-color: transparent;
    text-decoration: none;
    text-shadow: 0 -1px rgba(0, 0, 0, 0.5);
    text-align: center;

    width: 190px;
    line-height: 18px;

    display: inline-block;
    padding: 2px 0;

    border: 1.5px dotted #fff;
    border-color: rgba(255, 255, 255, 0.6);
  }

  .github-fork-ribbon-wrapper {
    display: block;
    width: 130px;
    height: 130px;
    position: absolute;
    overflow: hidden;
    top: 0; right: 0;
    z-index: 2;
    pointer-events: none;
  }
}
@media screen and (min-width: 1000px) {
  .github-fork-ribbon-wrapper {
    position: fixed;
  }
  /*]]>*/</style>


  <link href="#rfc.toc" rel="Contents">
<link href="#rfc.section.1" rel="Chapter" title="1 Introduction">
<link href="#rfc.section.1.1" rel="Chapter" title="1.1 Notational Conventions">
<link href="#rfc.section.2" rel="Chapter" title="2 Push Message Encryption Overview">
<link href="#rfc.section.2.1" rel="Chapter" title="2.1 Key and Secret Distribution">
<link href="#rfc.section.3" rel="Chapter" title="3 Push Message Encryption">
<link href="#rfc.section.3.1" rel="Chapter" title="3.1 Diffie-Hellman Key Agreement">
<link href="#rfc.section.3.2" rel="Chapter" title="3.2 Push Message Authentication">
<link href="#rfc.section.3.3" rel="Chapter" title="3.3 Combining Shared and Authentication Secrets">
<link href="#rfc.section.3.4" rel="Chapter" title="3.4 Encryption Summary">
<link href="#rfc.section.4" rel="Chapter" title="4 Restrictions on Use of &#8220;aes128gcm&#8221; Content Coding">
<link href="#rfc.section.5" rel="Chapter" title="5 Push Message Encryption Example">
<link href="#rfc.section.6" rel="Chapter" title="6 IANA Considerations">
<link href="#rfc.section.7" rel="Chapter" title="7 Security Considerations">
<link href="#rfc.references" rel="Chapter" title="8 References">
<link href="#rfc.references.1" rel="Chapter" title="8.1 Normative References">
<link href="#rfc.references.2" rel="Chapter" title="8.2 Informative References">
<link href="#rfc.appendix.A" rel="Chapter" title="A Intermediate Values for Encryption">
<link href="#rfc.authors" rel="Chapter">


  <meta name="generator" content="xml2rfc version 2.7.0 - http://tools.ietf.org/tools/xml2rfc" />
  <link rel="schema.dct" href="http://purl.org/dc/terms/" />

  <meta name="dct.creator" content="Thomson, M." />
  <meta name="dct.identifier" content="urn:ietf:id:draft-ietf-webpush-encryption-latest" />
  <meta name="dct.issued" scheme="ISO8601" content="2017-7-25" />
  <meta name="dct.abstract" content="A message encryption scheme is described for the Web Push protocol.  This scheme provides confidentiality and integrity for messages sent from an Application Server to a User Agent." />
  <meta name="description" content="A message encryption scheme is described for the Web Push protocol.  This scheme provides confidentiality and integrity for messages sent from an Application Server to a User Agent." />

</head>

<body>

  <table class="header">
    <tbody>
    
    	<tr>
<td class="left">Network Working Group</td>
<td class="right">M. Thomson</td>
</tr>
<tr>
<td class="left">Internet-Draft</td>
<td class="right">Mozilla</td>
</tr>
<tr>
<td class="left">Intended status: Standards Track</td>
<td class="right">July 25, 2017</td>
</tr>
<tr>
<td class="left">Expires: January 26, 2018</td>
<td class="right"></td>
</tr>

    	
    </tbody>
  </table>

  <p class="title">Message Encryption for Web Push<br />
  <span class="filename">draft-ietf-webpush-encryption-latest</span></p>
  
  <h1 id="rfc.abstract"><a href="#rfc.abstract">Abstract</a></h1>
<p>A message encryption scheme is described for the Web Push protocol.  This scheme provides confidentiality and integrity for messages sent from an Application Server to a User Agent.</p>
<h1 id="rfc.status"><a href="#rfc.status">Status of This Memo</a></h1>
<p>This Internet-Draft is submitted in full conformance with the provisions of BCP 78 and BCP 79.</p>
<p>Internet-Drafts are working documents of the Internet Engineering Task Force (IETF).  Note that other groups may also distribute working documents as Internet-Drafts.  The list of current Internet-Drafts is at http://datatracker.ietf.org/drafts/current/.</p>
<p>Internet-Drafts are draft documents valid for a maximum of six months and may be updated, replaced, or obsoleted by other documents at any time.  It is inappropriate to use Internet-Drafts as reference material or to cite them other than as "work in progress."</p>
<p>This Internet-Draft will expire on January 26, 2018.</p>
<h1 id="rfc.copyrightnotice"><a href="#rfc.copyrightnotice">Copyright Notice</a></h1>
<p>Copyright (c) 2017 IETF Trust and the persons identified as the document authors.  All rights reserved.</p>
<p>This document is subject to BCP 78 and the IETF Trust's Legal Provisions Relating to IETF Documents (http://trustee.ietf.org/license-info) in effect on the date of publication of this document.  Please review these documents carefully, as they describe your rights and restrictions with respect to this document.  Code Components extracted from this document must include Simplified BSD License text as described in Section 4.e of the Trust Legal Provisions and are provided without warranty as described in the Simplified BSD License.</p>

  
  <hr class="noprint" />
  <h1 class="np" id="rfc.toc"><a href="#rfc.toc">Table of Contents</a></h1>
  <ul class="toc">

  	<li>1.   <a href="#rfc.section.1">Introduction</a>
</li>
<ul><li>1.1.   <a href="#rfc.section.1.1">Notational Conventions</a>
</li>
</ul><li>2.   <a href="#rfc.section.2">Push Message Encryption Overview</a>
</li>
<ul><li>2.1.   <a href="#rfc.section.2.1">Key and Secret Distribution</a>
</li>
</ul><li>3.   <a href="#rfc.section.3">Push Message Encryption</a>
</li>
<ul><li>3.1.   <a href="#rfc.section.3.1">Diffie-Hellman Key Agreement</a>
</li>
<li>3.2.   <a href="#rfc.section.3.2">Push Message Authentication</a>
</li>
<li>3.3.   <a href="#rfc.section.3.3">Combining Shared and Authentication Secrets</a>
</li>
<li>3.4.   <a href="#rfc.section.3.4">Encryption Summary</a>
</li>
</ul><li>4.   <a href="#rfc.section.4">Restrictions on Use of &#8220;aes128gcm&#8221; Content Coding</a>
</li>
<li>5.   <a href="#rfc.section.5">Push Message Encryption Example</a>
</li>
<li>6.   <a href="#rfc.section.6">IANA Considerations</a>
</li>
<li>7.   <a href="#rfc.section.7">Security Considerations</a>
</li>
<li>8.   <a href="#rfc.references">References</a>
</li>
<ul><li>8.1.   <a href="#rfc.references.1">Normative References</a>
</li>
<li>8.2.   <a href="#rfc.references.2">Informative References</a>
</li>
</ul><li>Appendix A.   <a href="#rfc.appendix.A">Intermediate Values for Encryption</a>
</li>
<li><a href="#rfc.authors">Author's Address</a>
</li>


  </ul>

  <h1 id="rfc.section.1">
<a href="#rfc.section.1">1.</a> <a href="#introduction" id="introduction">Introduction</a>
</h1>
<p id="rfc.section.1.p.1">The Web Push protocol <a href="#RFC8030" class="xref">[RFC8030]</a> is an intermediated protocol by necessity.  Messages from an Application Server are delivered to a User Agent via a Push Service.</p>
<pre>
 +-------+           +--------------+       +-------------+
 |  UA   |           | Push Service |       | Application |
 +-------+           +--------------+       +-------------+
     |                      |                      |
     |        Setup         |                      |
     |&lt;====================&gt;|                      |
     |           Provide Subscription              |
     |--------------------------------------------&gt;|
     |                      |                      |
     :                      :                      :
     |                      |     Push Message     |
     |    Push Message      |&lt;---------------------|
     |&lt;---------------------|                      |
     |                      |                      |
</pre>
<p id="rfc.section.1.p.2">This document describes how messages sent using this protocol can be secured against inspection, modification and falsification by a Push Service.</p>
<p id="rfc.section.1.p.3">Web Push messages are the payload of an HTTP message <a href="#RFC7230" class="xref">[RFC7230]</a>.  These messages are encrypted using an encrypted content encoding <a href="#RFC8188" class="xref">[RFC8188]</a>.  This document describes how this content encoding is applied and describes a recommended key management scheme.</p>
<p id="rfc.section.1.p.4">For efficiency reasons, multiple users of Web Push often share a central agent that aggregates push functionality.  This agent can enforce the use of this encryption scheme by applications that use push messaging.  An agent that only delivers messages that are properly encrypted strongly encourages the end-to-end protection of messages.</p>
<p id="rfc.section.1.p.5">A web browser that implements the Web Push API <a href="#API" class="xref">[API]</a> can enforce the use of encryption by forwarding only those messages that were properly encrypted.</p>
<h2 id="rfc.section.1.1">
<a href="#rfc.section.1.1">1.1.</a> <a href="#notational-conventions" id="notational-conventions">Notational Conventions</a>
</h2>
<p id="rfc.section.1.1.p.1">The words &#8220;MUST&#8221;, &#8220;MUST NOT&#8221;, &#8220;SHOULD&#8221;, and &#8220;MAY&#8221; are used in this document.  It&#8217;s not shouting, when they are capitalized, they have the special meaning described in <a href="#RFC2119" class="xref">[RFC2119]</a>.</p>
<h1 id="rfc.section.2">
<a href="#rfc.section.2">2.</a> <a href="#overview" id="overview">Push Message Encryption Overview</a>
</h1>
<p id="rfc.section.2.p.1">Encrypting a push message uses elliptic-curve Diffie-Hellman (ECDH) <a href="#ECDH" class="xref">[ECDH]</a> on the P-256 curve <a href="#FIPS186" class="xref">[FIPS186]</a> to establish a shared secret (see <a href="#dh" class="xref">Section 3.1</a>) and a symmetric secret for authentication (see <a href="#auth" class="xref">Section 3.2</a>).</p>
<p id="rfc.section.2.p.2">A User Agent generates an ECDH key pair and authentication secret that it associates with each subscription it creates.  The ECDH public key and the authentication secret are sent to the Application Server with other details of the push subscription.</p>
<p id="rfc.section.2.p.3">When sending a message, an Application Server generates an ECDH key pair and a random salt.  The ECDH public key is encoded into the <samp>keyid</samp> parameter of the encrypted content coding header, the salt in the <samp>salt</samp> parameter of that same header (see Section 2.1 of <a href="#RFC8188" class="xref">[RFC8188]</a>).  The ECDH key pair can be discarded after encrypting the message.</p>
<p id="rfc.section.2.p.4">The content of the push message is encrypted or decrypted using a content encryption key and nonce that is derived using all of these inputs and the process described in <a href="#encryption" class="xref">Section 3</a>.</p>
<h2 id="rfc.section.2.1">
<a href="#rfc.section.2.1">2.1.</a> <a href="#key-and-secret-distribution" id="key-and-secret-distribution">Key and Secret Distribution</a>
</h2>
<p id="rfc.section.2.1.p.1">The application using the subscription distributes the subscription public key and authentication secret to an authorized Application Server.  This could be sent along with other subscription information that is provided by the User Agent, such as the push subscription URI.</p>
<p id="rfc.section.2.1.p.2">An application MUST use an authenticated, confidentiality protected communications medium for this purpose.  In addition to the reasons described in <a href="#RFC8030" class="xref">[RFC8030]</a>, this ensures that the authentication secret is not revealed to unauthorized entities, which can be used to generate push messages that will be accepted by the User Agent.</p>
<p id="rfc.section.2.1.p.3">Most applications that use push messaging have a pre-existing relationship with an Application Server that can be used to initiate and secure communications for key distribution.  Any existing communication mechanism that is authenticated and provides confidentiality and integrity, such as HTTPS <a href="#RFC2818" class="xref">[RFC2818]</a>, is sufficient.</p>
<h1 id="rfc.section.3">
<a href="#rfc.section.3">3.</a> <a href="#encryption" id="encryption">Push Message Encryption</a>
</h1>
<p id="rfc.section.3.p.1">Push message encryption happens in four phases:</p>
<p></p>

<ul>
<li>A shared secret is derived using elliptic-curve Diffie-Hellman <a href="#ECDH" class="xref">[ECDH]</a> (<a href="#dh" class="xref">Section 3.1</a>).</li>
<li>The shared secret is then combined with the authentication secret to produce the input keying material used in <a href="#RFC8188" class="xref">[RFC8188]</a> (<a href="#combine" class="xref">Section 3.3</a>).</li>
<li>A content encryption key and nonce are derived using the process in <a href="#RFC8188" class="xref">[RFC8188]</a>.</li>
<li>Encryption or decryption follows according to <a href="#RFC8188" class="xref">[RFC8188]</a>.</li>
</ul>
<p id="rfc.section.3.p.3">The key derivation process is summarized in <a href="#summary" class="xref">Section 3.4</a>.  Restrictions on the use of the encrypted content coding are described in <a href="#restrict" class="xref">Section 4</a>.</p>
<h2 id="rfc.section.3.1">
<a href="#rfc.section.3.1">3.1.</a> <a href="#dh" id="dh">Diffie-Hellman Key Agreement</a>
</h2>
<p id="rfc.section.3.1.p.1">For each new subscription that the User Agent generates for an Application, it also generates a P-256 <a href="#FIPS186" class="xref">[FIPS186]</a> key pair for use in elliptic-curve Diffie-Hellman (ECDH) <a href="#ECDH" class="xref">[ECDH]</a>.</p>
<p id="rfc.section.3.1.p.2">When sending a push message, the Application Server also generates a new ECDH key pair on the same P-256 curve.</p>
<p id="rfc.section.3.1.p.3">The ECDH public key for the Application Server is included as the &#8220;keyid&#8221; parameter in the encrypted content coding header (see Section 2.1 of <a href="#RFC8188" class="xref">[RFC8188]</a>.</p>
<p id="rfc.section.3.1.p.4">An Application Server combines its ECDH private key with the public key provided by the User Agent using the process described in <a href="#ECDH" class="xref">[ECDH]</a>; on receipt of the push message, a User Agent combines its private key with the public key provided by the Application Server in the <samp>keyid</samp> parameter in the same way.  These operations produce the same value for the ECDH shared secret.</p>
<h2 id="rfc.section.3.2">
<a href="#rfc.section.3.2">3.2.</a> <a href="#auth" id="auth">Push Message Authentication</a>
</h2>
<p id="rfc.section.3.2.p.1">To ensure that push messages are correctly authenticated, a symmetric authentication secret is added to the information generated by a User Agent.  The authentication secret is mixed into the key derivation process shown in <a href="#combine" class="xref">Section 3.3</a>.</p>
<p id="rfc.section.3.2.p.2">A User Agent MUST generate and provide a hard to guess sequence of 16 octets that is used for authentication of push messages.  This SHOULD be generated by a cryptographically strong random number generator <a href="#RFC4086" class="xref">[RFC4086]</a>.</p>
<h2 id="rfc.section.3.3">
<a href="#rfc.section.3.3">3.3.</a> <a href="#combine" id="combine">Combining Shared and Authentication Secrets</a>
</h2>
<p id="rfc.section.3.3.p.1">The shared secret produced by ECDH is combined with the authentication secret using HMAC-based key derivation function (HKDF) described in <a href="#RFC5869" class="xref">[RFC5869]</a>.  This produces the input keying material used by <a href="#RFC8188" class="xref">[RFC8188]</a>.</p>
<p id="rfc.section.3.3.p.2">The HKDF function uses SHA-256 hash algorithm <a href="#FIPS180-4" class="xref">[FIPS180-4]</a> with the following inputs:</p>
<pre>
key_info = "WebPush: info" || 0x00 || ua_public || as_public
</pre>
<p></p>

<dl>
<dt>salt:</dt>
<dd style="margin-left: 8">the authentication secret</dd>
<dt>IKM:</dt>
<dd style="margin-left: 8">the shared secret derived using ECDH</dd>
<dt>info:</dt>
<dd style="margin-left: 8">the concatenation of the ASCII-encoded string &#8220;WebPush: info&#8221;, a zero octet, and the User Agent ECDH public key and the Application Server ECDH public key, both in the uncompressed point form defined in <a href="#X9.62" class="xref">[X9.62]</a>; that is </dd>
<dt>L:</dt>
<dd style="margin-left: 8">32 octets (i.e., the output is the length of the underlying SHA-256 HMAC function output)</dd>
</dl>
<h2 id="rfc.section.3.4">
<a href="#rfc.section.3.4">3.4.</a> <a href="#summary" id="summary">Encryption Summary</a>
</h2>
<p id="rfc.section.3.4.p.1">This results in a the final content encryption key and nonce generation using the following sequence, which is shown here in pseudocode with HKDF expanded into separate discrete steps using HMAC with SHA-256:</p>
<pre>
   -- For a User Agent:
   ecdh_secret = ECDH(ua_private, as_public)
   auth_secret = random(16)

   -- For an Application Server:
   ecdh_secret = ECDH(as_private, ua_public)
   auth_secret = &lt;from User Agent&gt;

   -- For both:

   ## Use HKDF to combine the ECDH and authentication secrets
   # HKDF-Extract(salt=auth_secret, IKM=ecdh_secret)
   PRK_key = HMAC-SHA-256(auth_secret, ecdh_secret)
   # HKDF-Expand(PRK_key, key_info, L_key=32)
   key_info = "WebPush: info" || 0x00 || ua_public || as_public
   IKM = HMAC-SHA-256(PRK_key, key_info || 0x01)

   ## HKDF calculations from RFC 8188
   # HKDF-Extract(salt, IKM)
   salt = random(16)
   PRK = HMAC-SHA-256(salt, IKM)
   # HKDF-Expand(PRK, cek_info, L_cek=16)
   cek_info = "Content-Encoding: aes128gcm" || 0x00
   CEK = HMAC-SHA-256(PRK, cek_info || 0x01)[0..15]
   # HKDF-Expand(PRK, nonce_info, L_nonce=12)
   nonce_info = "Content-Encoding: nonce" || 0x00
   NONCE = HMAC-SHA-256(PRK, nonce_info || 0x01)[0..11]
</pre>
<p id="rfc.section.3.4.p.2">Note that this omits the exclusive OR of the final nonce with the record sequence number, since push messages contain only a single record (see <a href="#restrict" class="xref">Section 4</a>) and the sequence number of the first record is zero.</p>
<h1 id="rfc.section.4">
<a href="#rfc.section.4">4.</a> <a href="#restrict" id="restrict">Restrictions on Use of &#8220;aes128gcm&#8221; Content Coding</a>
</h1>
<p id="rfc.section.4.p.1">An Application Server MUST encrypt a push message with a single record.  This allows for a minimal receiver implementation that handles a single record.  An application server MUST set the <samp>rs</samp> parameter in the <samp>aes128gcm</samp> content coding header to a size that is greater than the sum of the lengths of the plaintext, the padding delimiter (1 octet), any padding, and the authentication tag (16 octets).</p>
<p id="rfc.section.4.p.2">A push message MUST include the application server ECDH public key in the <samp>keyid</samp> parameter of the encrypted content coding header.  The uncompressed point form defined in <a href="#X9.62" class="xref">[X9.62]</a> (that is, a 65 octet sequence that starts with a 0x04 octet) forms the entirety of the <samp>keyid</samp>.  Note that this means that the <samp>keyid</samp> parameter will not be valid UTF-8 as recommended in <a href="#RFC8188" class="xref">[RFC8188]</a>.</p>
<p id="rfc.section.4.p.3">A push service is not required to support more than 4096 octets of payload body (see Section 7.2 of <a href="#RFC8030" class="xref">[RFC8030]</a>).  Absent header (86 octets), padding (minimum 2 octets), and expansion for AEAD_AES_128_GCM (16 octets), this equates to at most 3992 octets of plaintext.</p>
<p id="rfc.section.4.p.4">An Application Server MUST NOT use other content encodings for push messages.  In particular, content encodings that compress could result in leaking of push message contents.  The Content-Encoding header field therefore has exactly one value, which is <samp>aes128gcm</samp>.  Multiple <samp>aes128gcm</samp> values are not permitted.</p>
<p id="rfc.section.4.p.5">A User Agent is not required to support multiple records.  A User Agent MAY ignore the <samp>rs</samp> field.  If a record size is unchecked, decryption will fail with high probability for all valid cases.  The padding delimiter octet MUST be checked, values other than 0x02 MUST cause the message to be discarded.</p>
<h1 id="rfc.section.5">
<a href="#rfc.section.5">5.</a> <a href="#example" id="example">Push Message Encryption Example</a>
</h1>
<p id="rfc.section.5.p.1">The following example shows a push message being sent to a push service.</p>
<pre>
POST /push/JzLQ3raZJfFBR0aqvOMsLrt54w4rJUsV HTTP/1.1
Host: push.example.net
TTL: 10
Content-Length: 145
Content-Encoding: aes128gcm

DGv6ra1nlYgDCS1FRnbzlwAAEABBBP4z9KsN6nGRTbVYI_c7VJSPQTBtkgcy27ml
mlMoZIIgDll6e3vCYLocInmYWAmS6TlzAC8wEqKK6PBru3jl7A_yl95bQpu6cVPT
pK4Mqgkf1CXztLVBSt2Ks3oZwbuwXPXLWyouBWLVWGNWQexSgSxsj_Qulcy4a-fN
</pre>
<p id="rfc.section.5.p.2">This example shows the ASCII encoded string, &#8220;When I grow up, I want to be a watermelon&#8221;. The content body is shown here with line wrapping and URL-safe base64url encoding to meet presentation constraints.</p>
<p id="rfc.section.5.p.3">The keys used are shown below using the uncompressed form <a href="#X9.62" class="xref">[X9.62]</a> encoded using base64url.</p>
<pre>
   Authentication Secret: BTBZMqHH6r4Tts7J_aSIgg
   Receiver:
      private key: q1dXpw3UpT5VOmu_cf_v6ih07Aems3njxI-JWgLcM94
      public key: BCVxsr7N_eNgVRqvHtD0zTZsEc6-VV-JvLexhqUzORcx
                  aOzi6-AYWXvTBHm4bjyPjs7Vd8pZGH6SRpkNtoIAiw4
   Sender:
      private key: yfWPiYE-n46HLnH0KqZOF1fJJU3MYrct3AELtAQ-oRw
      public key: BP4z9KsN6nGRTbVYI_c7VJSPQTBtkgcy27mlmlMoZIIg
                  Dll6e3vCYLocInmYWAmS6TlzAC8wEqKK6PBru3jl7A8
</pre>
<p id="rfc.section.5.p.4">Intermediate values for this example are included in <a href="#ex-intermediate" class="xref">Appendix A</a>.</p>
<h1 id="rfc.section.6">
<a href="#rfc.section.6">6.</a> <a href="#iana" id="iana">IANA Considerations</a>
</h1>
<p id="rfc.section.6.p.1">[[RFC EDITOR: please remove this section before publication.]] This document makes no request of IANA.</p>
<h1 id="rfc.section.7">
<a href="#rfc.section.7">7.</a> <a href="#security-considerations" id="security-considerations">Security Considerations</a>
</h1>
<p id="rfc.section.7.p.1">The security considerations of <a href="#RFC8188" class="xref">[RFC8188]</a> describe the limitations of the content encoding.  In particular, any HTTP header fields are not protected by the content encoding scheme.  A User Agent MUST consider HTTP header fields to have come from the Push Service.  Though header fields might be necessary for processing an HTTP response correctly, they are not needed for correct operation of the protocol.  An application on the User Agent that uses information from header fields to alter their processing of a push message is exposed to a risk of attack by the Push Service.</p>
<p id="rfc.section.7.p.2">The timing and length of communication cannot be hidden from the Push Service.  While an outside observer might see individual messages intermixed with each other, the Push Service will see which Application Server is talking to which User Agent, and the subscription that is used.  Additionally, the length of messages could be revealed unless the padding provided by the content encoding scheme is used to obscure length.</p>
<p id="rfc.section.7.p.3">The User Agent and Application MUST verify that the public key they receive is on the P-256 curve.  Failure to validate a public key can allow an attacker to extract a private key.</p>
<h1 id="rfc.references">
<a href="#rfc.references">8.</a> References</h1>
<h2 id="rfc.references.1">
<a href="#rfc.references.1">8.1.</a> Normative References</h2>
<table><tbody>
<tr>
<td class="reference"><b id="ECDH">[ECDH]</b></td>
<td class="top">
<a>SECG</a>, "<a href="http://www.secg.org/">Elliptic Curve Cryptography</a>", SEC 1 , 2000.</td>
</tr>
<tr>
<td class="reference"><b id="FIPS180-4">[FIPS180-4]</b></td>
<td class="top">
<a>Department of Commerce, National.</a>, "<a href="http://nvlpubs.nist.gov/nistpubs/FIPS/NIST.FIPS.180-4.pdf">NIST FIPS 180-4, Secure Hash Standard</a>", March 2012.</td>
</tr>
<tr>
<td class="reference"><b id="FIPS186">[FIPS186]</b></td>
<td class="top">
<a>National Institute of Standards and Technology (NIST)</a>, "<a>Digital Signature Standard (DSS)</a>", NIST PUB 186-4 , July 2013.</td>
</tr>
<tr>
<td class="reference"><b id="RFC2119">[RFC2119]</b></td>
<td class="top">
<a>Bradner, S.</a>, "<a href="http://tools.ietf.org/html/rfc2119">Key words for use in RFCs to Indicate Requirement Levels</a>", BCP 14, RFC 2119, DOI 10.17487/RFC2119, March 1997.</td>
</tr>
<tr>
<td class="reference"><b id="RFC4086">[RFC4086]</b></td>
<td class="top">
<a>Eastlake 3rd, D.</a>, <a>Schiller, J.</a> and <a>S. Crocker</a>, "<a href="http://tools.ietf.org/html/rfc4086">Randomness Requirements for Security</a>", BCP 106, RFC 4086, DOI 10.17487/RFC4086, June 2005.</td>
</tr>
<tr>
<td class="reference"><b id="RFC5869">[RFC5869]</b></td>
<td class="top">
<a>Krawczyk, H.</a> and <a>P. Eronen</a>, "<a href="http://tools.ietf.org/html/rfc5869">HMAC-based Extract-and-Expand Key Derivation Function (HKDF)</a>", RFC 5869, DOI 10.17487/RFC5869, May 2010.</td>
</tr>
<tr>
<td class="reference"><b id="RFC8030">[RFC8030]</b></td>
<td class="top">
<a>Thomson, M.</a>, <a>Damaggio, E.</a> and <a>B. Raymor</a>, "<a href="http://tools.ietf.org/html/rfc8030">Generic Event Delivery Using HTTP Push</a>", RFC 8030, DOI 10.17487/RFC8030, December 2016.</td>
</tr>
<tr>
<td class="reference"><b id="RFC8188">[RFC8188]</b></td>
<td class="top">
<a>Thomson, M.</a>, "<a href="http://tools.ietf.org/html/rfc8188">Encrypted Content-Encoding for HTTP</a>", RFC 8188, DOI 10.17487/RFC8188, June 2017.</td>
</tr>
<tr>
<td class="reference"><b id="X9.62">[X9.62]</b></td>
<td class="top">
<a>ANSI</a>, "<a>Public Key Cryptography For The Financial Services Industry: The Elliptic Curve Digital Signature Algorithm (ECDSA)</a>", ANSI X9.62 , 1998.</td>
</tr>
</tbody></table>
<h2 id="rfc.references.2">
<a href="#rfc.references.2">8.2.</a> Informative References</h2>
<table><tbody>
<tr>
<td class="reference"><b id="API">[API]</b></td>
<td class="top">
<a>Beverloo, P.</a> and <a>M. Thomson</a>, "<a href="https://w3c.github.io/push-api/">Web Push API</a>", 2015.</td>
</tr>
<tr>
<td class="reference"><b id="RFC2818">[RFC2818]</b></td>
<td class="top">
<a>Rescorla, E.</a>, "<a href="http://tools.ietf.org/html/rfc2818">HTTP Over TLS</a>", RFC 2818, DOI 10.17487/RFC2818, May 2000.</td>
</tr>
<tr>
<td class="reference"><b id="RFC7230">[RFC7230]</b></td>
<td class="top">
<a>Fielding, R.</a> and <a>J. Reschke</a>, "<a href="http://tools.ietf.org/html/rfc7230">Hypertext Transfer Protocol (HTTP/1.1): Message Syntax and Routing</a>", RFC 7230, DOI 10.17487/RFC7230, June 2014.</td>
</tr>
</tbody></table>
<h1 id="rfc.appendix.A">
<a href="#rfc.appendix.A">Appendix A.</a> <a href="#ex-intermediate" id="ex-intermediate">Intermediate Values for Encryption</a>
</h1>
<p id="rfc.section.A.p.1">The intermediate values calculated for the example in <a href="#example" class="xref">Section 5</a> are shown here.  The following are inputs to the calculation:</p>
<p></p>

<dl>
<dt>Plaintext:</dt>
<dd style="margin-left: 8">V2hlbiBJIGdyb3cgdXAsIEkgd2FudCB0byBiZSBhIHdhdGVybWVsb24</dd>
<dt>Application Server public key (as_public):</dt>
<dd style="margin-left: 8">BP4z9KsN6nGRTbVYI_c7VJSPQTBtkgcy27mlmlMoZIIg Dll6e3vCYLocInmYWAmS6TlzAC8wEqKK6PBru3jl7A8</dd>
<dt>Application Server private key (as_private):</dt>
<dd style="margin-left: 8">yfWPiYE-n46HLnH0KqZOF1fJJU3MYrct3AELtAQ-oRw</dd>
<dt>User Agent public key (ua_public):</dt>
<dd style="margin-left: 8">BCVxsr7N_eNgVRqvHtD0zTZsEc6-VV-JvLexhqUzORcx aOzi6-AYWXvTBHm4bjyPjs7Vd8pZGH6SRpkNtoIAiw4</dd>
<dt>User Agent private key (ua_private):</dt>
<dd style="margin-left: 8">q1dXpw3UpT5VOmu_cf_v6ih07Aems3njxI-JWgLcM94</dd>
<dt>Salt:</dt>
<dd style="margin-left: 8">DGv6ra1nlYgDCS1FRnbzlw</dd>
<dt>Authentication secret (auth_secret):</dt>
<dd style="margin-left: 8">BTBZMqHH6r4Tts7J_aSIgg</dd>
</dl>
<p id="rfc.section.A.p.3">Note that knowledge of just one of the private keys is necessary.  The Application Server randomly generates the salt value, whereas salt is input to the receiver.</p>
<p id="rfc.section.A.p.4">This produces the following intermediate values:</p>
<p></p>

<dl>
<dt>Shared ECDH secret (ecdh_secret):</dt>
<dd style="margin-left: 8">kyrL1jIIOHEzg3sM2ZWRHDRB62YACZhhSlknJ672kSs</dd>
<dt>Pseudo-random key for key combining (PRK_key):</dt>
<dd style="margin-left: 8">Snr3JMxaHVDXHWJn5wdC52WjpCtd2EIEGBykDcZW32k</dd>
<dt>Info for key combining (key_info):</dt>
<dd style="margin-left: 8">V2ViUHVzaDogaW5mbwAEJXGyvs3942BVGq8e0PTNNmwR zr5VX4m8t7GGpTM5FzFo7OLr4BhZe9MEebhuPI-OztV3 ylkYfpJGmQ22ggCLDgT-M_SrDepxkU21WCP3O1SUj0Ew bZIHMtu5pZpTKGSCIA5Zent7wmC6HCJ5mFgJkuk5cwAv MBKiiujwa7t45ewP</dd>
<dt>Input keying material for content encryption key derivation (IKM):</dt>
<dd style="margin-left: 8">S4lYMb_L0FxCeq0WhDx813KgSYqU26kOyzWUdsXYyrg</dd>
<dt>PRK for content encryption (PRK):</dt>
<dd style="margin-left: 8">09_eUZGrsvxChDCGRCdkLiDXrReGOEVeSCdCcPBSJSc</dd>
<dt>Info for content encryption key derivation (cek_info):</dt>
<dd style="margin-left: 8">Q29udGVudC1FbmNvZGluZzogYWVzMTI4Z2NtAA</dd>
<dt>Content encryption key (CEK):</dt>
<dd style="margin-left: 8">oIhVW04MRdy2XN9CiKLxTg</dd>
<dt>Info for content encryption nonce derivation (nonce_info):</dt>
<dd style="margin-left: 8">Q29udGVudC1FbmNvZGluZzogbm9uY2UA</dd>
<dt>Nonce (NONCE):</dt>
<dd style="margin-left: 8">4h_95klXJ5E_qnoN</dd>
</dl>
<p id="rfc.section.A.p.6">The salt, record size of 4096, and application server public key produce an 86 octet header of DGv6ra1nlYgDCS1FRnbzlwAAEABBBP4z 9KsN6nGRTbVYI_c7VJSPQTBtkgcy27ml mlMoZIIgDll6e3vCYLocInmYWAmS6Tlz AC8wEqKK6PBru3jl7A8.</p>
<p id="rfc.section.A.p.7">The push message plaintext has the padding delimiter octet (0x02) appended to produce V2hlbiBJIGdyb3cgdXAsIEkgd2FudCB0 byBiZSBhIHdhdGVybWVsb24C.  The plaintext is then encrypted with AES-GCM, which emits ciphertext of 8pfeW0KbunFT06SuDKoJH9Ql87S1QUrd irN6GcG7sFz1y1sqLgVi1VhjVkHsUoEs bI_0LpXMuGvnzQ.</p>
<p id="rfc.section.A.p.8">The header and cipher text are concatenated and produce the result shown in <a href="#example" class="xref">Section 5</a>.</p>
<h1 id="rfc.authors"><a href="#rfc.authors">Author's Address</a></h1>
<div class="avoidbreak">
  <address class="vcard">
	<span class="vcardline">
	  <span class="fn">Martin Thomson</span> 
	  <span class="n hidden">
		<span class="family-name">Thomson</span>
	  </span>
	</span>
	<span class="org vcardline">Mozilla</span>
	<span class="adr">
	  
	  <span class="vcardline">
		<span class="locality"></span> 
		<span class="region"></span>
		<span class="code"></span>
	  </span>
	  <span class="country-name vcardline"></span>
	</span>
	<span class="vcardline">EMail: <a href="mailto:martin.thomson@gmail.com">martin.thomson@gmail.com</a></span>

  </address>
</div>

  <div class="github-fork-ribbon-wrapper"><div class="github-fork-ribbon"><a href="https://github.com/webpush-wg/webpush-encryption">Fork me on GitHub</a></div></div>
</body>
</html>
